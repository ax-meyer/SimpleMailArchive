@using System.Text.Json
@using Microsoft.JSInterop
@using Radzen
@using Radzen.Blazor
@using SimpleMailArchiver.Data
@using SimpleMailArchiver.Services
@inject DialogService DialogService
@inject FileDownloadHelperContext DownloadHelperContext
@inject IJSRuntime JsRuntime

<RadzenStack Class="display-mail-root">

    <!-- HEADER -->
    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center"
                 JustifyContent="JustifyContent.SpaceBetween" Class="display-mail-header">

        <RadzenHeading Size="H4" Class="subject-heading">@Message.Subject</RadzenHeading>

        <RadzenStack Orientation="Orientation.Horizontal" Gap="10px" Class="action-buttons">
            <RadzenButton Text="Download" Icon="download"
                          ButtonStyle="ButtonStyle.Primary"
                          Click="@Download"/>
        </RadzenStack>

    </RadzenStack>

    <!-- MESSAGE META DATA -->
    <RadzenPanel ExpandMode="PanelExpandMode.Single" Class="message-panel">
        <HeaderTemplate>
            <b>Message Details</b>
        </HeaderTemplate>

        <ChildContent>
            <div class="message-meta">
                <DisplayMailMetaRow Label="From:" Value="@Message.Sender" />
                <DisplayMailMetaRow Label="To:" Value="@Message.Recipient" />
                <DisplayMailMetaRow Label="Date:" Value="@Message.Date" />
                <DisplayMailMetaRow Label="Subject:" Value="@Message.Subject" />

                @if (!string.IsNullOrWhiteSpace(Message.CcRecipient))
                {
                    <DisplayMailMetaRow Label="CC:" Value="@Message.CcRecipient" />
                }

                @if (!string.IsNullOrWhiteSpace(Message.BccRecipient))
                {
                    <DisplayMailMetaRow Label="BCC:" Value="@Message.BccRecipient" />
                }

                @if (HasAttachments())
                {
                    <RadzenRow Class="meta-row">
                        <RadzenColumn Size="3"><b>Attachments:</b></RadzenColumn>
                        <RadzenColumn>
                            @foreach (var file in GetAttachments())
                            {
                                <div class="attachment-file">@file</div>
                            }
                        </RadzenColumn>
                    </RadzenRow>
                }
            </div>
        </ChildContent>
    </RadzenPanel>

    <!-- BODY (HTML / TEXT SWITCH) -->
    <RadzenTabs Class="display-mail-tabs">
        <Tabs>
            @if (!string.IsNullOrWhiteSpace(Message.HtmlBody))
            {
                <RadzenTabsItem Text="HTML Body">
                    <div class="tab-content">
                        @((MarkupString)Message.HtmlBody)
                    </div>
                </RadzenTabsItem>
            }

            @if (!string.IsNullOrWhiteSpace(Message.TextBody))
            {
                <RadzenTabsItem Text="Text Body">
                    <div class="tab-content">
                        @FormatTextBody()
                    </div>
                </RadzenTabsItem>
            }
        </Tabs>
    </RadzenTabs>

</RadzenStack>

@code {
    [Parameter] public required MailMessage Message { get; set; }
    
    private async Task Download()
    {
        await DownloadHelperContext.PrepareMessageForDownload(Message, CancellationToken.None);
        await JsRuntime.InvokeVoidAsync("open", "download", "_blank");
    }

    private bool HasAttachments()
        => Message.HasAttachments;

    private IEnumerable<string> GetAttachments()
    {
        string attachments = Message.Attachments is null ? string.Empty : Message.Attachments;
        if (string.IsNullOrWhiteSpace(attachments) || attachments.Trim() == "[]")
            return Array.Empty<string>();

        try
        {
            var list = JsonSerializer.Deserialize<List<string>>(attachments);
            if (list == null) return new List<string> { attachments };
            return list;
        }
        catch
        {
            return new List<string> { attachments };
        }
    }

    private MarkupString FormatTextBody()
    {
        var raw = Message.TextBody;
        var html = raw
            .Replace("\r\n", "<br/>")
            .Replace("\n\r", "<br/>")
            .Replace("\r", "<br/>")
            .Replace("\n", "<br/>");
        return (MarkupString)html;
    }

}
