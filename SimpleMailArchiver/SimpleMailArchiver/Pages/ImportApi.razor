@page "/import-api"
@using Microsoft.AspNetCore.WebUtilities
@using SimpleMailArchiver.Data
@using SimpleMailArchiver.Services.MessageImportService
@inject ILoggerFactory LoggerFactory;
@inject NavigationManager NavManager
@inject MessageImportService MessageImportService;
@inject ApplicationContext AppContext;


@code {
    private ILogger<ImportApi> _logger = null!;

    protected override void OnInitialized()
    {
        _logger = LoggerFactory.CreateLogger<ImportApi>();
        AppContext.ImportManager.Start(async (progress, ct) => await ExecuteImport(progress, ct));
    }

    private async Task ExecuteImport(ImportProgress progress, CancellationToken ct)
    {
        var uri = NavManager.ToAbsoluteUri(NavManager.Uri);
        _logger.LogInformation("called URI {Uri}", uri);

        using var client = new HttpClient();
        client.Timeout = TimeSpan.FromSeconds(10);
        var callBackUrl = "";
        if (QueryHelpers.ParseQuery(uri.Query).TryGetValue("callBackUrl", out var callback))
        {
            callBackUrl = callback.ToString().Trim().TrimEnd('/');

            _logger.LogInformation("callback url: {CallBackUrl}", callBackUrl);

            try
            {
                await HttpGetRetry(client, callBackUrl + "/start", 10, CancellationToken.None);
            }
            catch (Exception ex)
            {
                _logger.LogError("Calling {CallBackUrl} failed with error {ExMessage}", callBackUrl, ex.Message);
                return;
            }
        }
        else
        {
            _logger.LogInformation("No callback url found");
        }


        if (QueryHelpers.ParseQuery(uri.Query).TryGetValue("accountFilename", out var filename))
        {
            var accountFilename = filename.ToString().Trim().TrimEnd('/').TrimStart('/');
            _logger.LogInformation("API import for account file: {AccountFilename}", accountFilename);

            if (AppContext.Accounts.Any(acc => acc.AccountFilename == accountFilename))
            {
                try
                {
                    await MessageImportService.ImportFromServer(accountFilename, progress, ct);

                    var msg = $"Import successful. Account {accountFilename}" +
                              $"\nParsed: {progress.ParsedMessageCount}" +
                              $"\nImported : {progress.ImportedMessageCount}" +
                              $"\nDeleted server: {progress.RemoteMessagesDeletedCount}" +
                              $"\nDeleted local: {progress.LocalMessagesDeletedCount}";

                    if (callBackUrl != string.Empty)
                        await HttpPostRetry(client, callBackUrl, msg, 10, CancellationToken.None);
                    _logger.LogInformation(msg);
                }
                catch (Exception ex)
                {
                    var errmsg = $"API import failed with error \"{ex.Message}\"";
                    _logger.LogError(errmsg);

                    if (callBackUrl != string.Empty)
                        await HttpPostRetry(client, callBackUrl + "/fail", errmsg, 10, CancellationToken.None);
                }
            }
            else
            {
                var errmsg = $"No account found for \"{accountFilename}\". Check log at startup to see account loading errors";
                _logger.LogError(errmsg);
                if (callBackUrl != string.Empty)
                    await HttpPostRetry(client, callBackUrl + "/fail", errmsg, 10, CancellationToken.None);
            }
        }
        else
        {
            const string errmsg = "No account filename provided, api import failed";
            _logger.LogError(errmsg);

            if (callBackUrl != string.Empty)
                await HttpPostRetry(client, callBackUrl + "/fail", errmsg, 10, CancellationToken.None);
        }
    }

    private async Task HttpGetRetry(HttpClient client, string url, int retries, CancellationToken token = default)
    {
        var counter = 0;
        var retry = true;
        while (retry)
        {
            try
            {
                await client.GetAsync(url, token);
                retry = false;
            }
            catch
            {
                if (++counter >= retries)
                    throw;
            }
        }
    }

    private async Task HttpPostRetry(HttpClient client, string url, string message, int retries, CancellationToken token = default)
    {
        var counter = 0;
        var retry = true;
        while (retry)
        {
            try
            {
                await client.PostAsync(url, new StringContent(message), token);
                retry = false;
            }
            catch
            {
                if (++counter >= retries)
                    throw;
            }
        }
    }

}
